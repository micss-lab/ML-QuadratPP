<!--

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

         http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

    See the NOTICE file distributed with this work for additional
    information regarding copyright ownership.

-->
<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset=utf-8 http-equiv="Content-Language" content="en"/>
 <title>Arduino Yun debugger: Control pannel</title>
<style type="text/css">
	div.title { font-size:18pt; font: Arial; font-weight:normal; text-align:center; color:#000000; }
	.browser { font-size:18pt; font: Arial; font-weight:normal; text-align:center; color:#ffff00; vertical-align:middle; text-align:center; background:#d0b070; padding:12px; -webkit-border-radius:10px; -moz-border-radius:10px; border-radius:10px;}
	.group2 { vertical-align:middle; text-align:center; background:#f0f0e0; padding:12px; -webkit-border-radius:10px; -moz-border-radius:10px; border-radius:10px; }
	.explain { vertical-align:middle; text-align:center; background:#f0f0c0; padding:12px; -webkit-border-radius:10px; -moz-border-radius:10px; border-radius:10px; color:#404000; }
	.content { vertical-align:top; text-align:center; background:#fffff0; padding:12px; -webkit-border-radius:10px; -moz-border-radius:10px; border-radius:10px; }
	.canvas { vertical-align:top; text-align:center; background:#efefd0; padding:12px; -webkit-border-radius:10px; -moz-border-radius:10px; border-radius:10px; }
</style>
</head>

<body>
<header></header>
<article>

<table><tr><td>

<section id="increment" class="group2">
<div class="title">Yun debugger</div>

<table class="content">
	<tr>
		<td>Satus</td>
		<td>Val</td>
		<td width="50">Pin</td>
		<td rowspan=15><img src="arduino-yun.png" /></td>
		<td width="50">Pin</td>
		<td>Send</td>
		<td>Val</td>
		<td width="50"> I/O </td>
		<td>Satus</td>
	</tr>
	<tr>
		<td rowspan=8></td>
		<td rowspan=8></td>
		<td rowspan=8></td>
		<td>13</td>
		<td><input type=button id=offset value="Send" onclick="CMD(13,3);" ></td>
		<td><input id="val13" value="0"></td>
		<td><input type=button id=IO13 value="I" onclick="CMD(13,2);" ></td>
		<td><input type=button id=status13 value="Off" onclick="CMD(13,1);" ></td>
	</tr>
	<tr>
		<td>12</td>
		<td><input type=button id=offset value="Send" onclick="CMD(12,3);" ></td>
		<td><input id="val12" value="0"></td>
		<td><input type=button id=IO12 value="I" onclick="CMD(12,2);" ></td>
		<td><input type=button id=status12 value="Off" onclick="CMD(12,1);" ></td>
	</tr>
	<tr>
		<td>11</td>
		<td><input type=button id=offset value="Send" onclick="CMD(11,3);" ></td>
		<td><input id="val11" value="0"></td>
		<td><input type=button id=IO11 value="I" onclick="CMD(11,2);" ></td>
		<td><input type=button id=status11 value="Off" onclick="CMD(11,1);" ></td>
	</tr>
	<tr>
		<td>10</td>
		<td><input type=button id=offset value="Send" onclick="CMD(10,3);" ></td>
		<td><input id="val10" value="0"></td>
		<td><input type=button id=IO10 value="I" onclick="CMD(10,2);" ></td>
		<td><input type=button id=status10 value="Off" onclick="CMD(10,1);" ></td>
	</tr>
	<tr>
		<td>9</td>
		<td><input type=button id=offset value="Send" onclick="CMD(9,3);" ></td>
		<td><input id="val9" value="0"></td>
		<td><input type=button id=IO9 value="I" onclick="CMD(9,2);" ></td>
		<td><input type=button id=status9 value="Off" onclick="CMD(9,1);" ></td>
	</tr>
	<tr>
		<td>8</td>
		<td><input type=button id=offset value="Send" onclick="CMD(8,3);" ></td>
		<td><input id="val8" value="0"></td>
		<td><input type=button id=IO8 value="I" onclick="CMD(8,2);" ></td>
		<td><input type=button id=status8 value="Off" onclick="CMD(8,1);" ></td>
	</tr>
	<tr>
		<td>7</td>
		<td><input type=button id=offset value="Send" onclick="CMD(7,3);" ></td>
		<td><input id="val7" value="0"></td>
		<td><input type=button id=IO7 value="I" onclick="CMD(7,2);" ></td>
		<td><input type=button id=status7 value="Off" onclick="CMD(7,1);" ></td>
	</tr>
	<tr>
		<td>6</td>
		<td><input type=button id=offset value="Send" onclick="CMD(6,3);" ></td>
		<td><input id="val6" value="0"></td>
		<td><input type=button id=IO6 value="I" onclick="CMD(6,2);" ></td>
		<td><input type=button id=status6 value="Off" onclick="CMD(6,1);" ></td>
	</tr>
	<tr>
		<td><input type=button id=status14 value="Off" onclick="CMD(14,1);" ></td>
		<td><input id="val14" value="0"></td>
		<td>A0</td>
		<td>5</td>
		<td><input type=button id=offset value="Send" onclick="CMD(5,3);" ></td>
		<td><input id="val5" value="0"></td>
		<td><input type=button id=IO5 value="I" onclick="CMD(5,2);" ></td>
		<td><input type=button id=status5 value="Off" onclick="CMD(5,1);" ></td>
	</tr>
	<tr>
		<td><input type=button id=status15 value="Off" onclick="CMD(15,1);" ></td>
		<td><input id="val15" value="0"></td>
		<td>A1</td>
		<td>4</td>
		<td><input type=button id=offset value="Send" onclick="CMD(4,3);" ></td>
		<td><input id="val4" value="0"></td>
		<td><input type=button id=IO4 value="I" onclick="CMD(4,2);" ></td>
		<td><input type=button id=status4 value="Off" onclick="CMD(4,1);" ></td>
	</tr>
	<tr>
		<td><input type=button id=status16 value="Off" onclick="CMD(16,1);" ></td>
		<td><input id="val16" value="0"></td>
		<td>A2</td>
		<td>3</td>
		<td><input type=button id=offset value="Send" onclick="CMD(3,3);" ></td>
		<td><input id="val3" value="0"></td>
		<td><input type=button id=IO3 value="I" onclick="CMD(3,2);" ></td>
		<td><input type=button id=status3 value="Off" onclick="CMD(3,1);" ></td>
	</tr>
	<tr>
		<td><input type=button id=status17 value="Off" onclick="CMD(17,1);" ></td>
		<td><input id="val17" value="0"></td>
		<td>A3</td>
		<td>2</td>
		<td><input type=button id=offset value="Send" onclick="CMD(2,3);" ></td>
		<td><input id="val2" value="0"></td>
		<td><input type=button id=IO2 value="I" onclick="CMD(2,2);" ></td>
		<td><input type=button id=status2 value="Off" onclick="CMD(2,1);" ></td>
	</tr>
	<tr>
		<td><input type=button id=status18 value="Off" onclick="CMD(18,1);" ></td>
		<td><input id="val18" value="0"></td>
		<td>A4</td>
		<td>1</td>
		<td><input type=button id=offset value="Send" onclick="CMD(1,3);" ></td>
		<td><input id="val1" value="0"></td>
		<td><input type=button id=IO1 value="I" onclick="CMD(1,2);" ></td>
		<td><input type=button id=status1 value="Off" onclick="CMD(1,1);" ></td>
	</tr>
	<tr>
		<td><input type=button id=status19 value="Off" onclick="CMD(19,1);" ></td>
		<td><input id="val19" value="0"></td>
		<td>A5</td>
		<td>0</td>
		<td><input type=button id=offset value="Send" onclick="CMD(0,3);" ></td>
		<td><input id="val0" value="0"></td>
		<td><input type=button id=IO0 value="I" onclick="CMD(0,2);" ></td>
		<td><input type=button id=status0 value="Off" onclick="CMD(0,1);" ></td>
	</tr>
	<tr><td width=200px align=center><div id=lastmsg> none </div></td></tr>
	<tr><td width=200px align=center><div id=info> none </div></td></tr>
	<tr><td id=wsdi_statustd align=center class="explain" colspan=12><div id=wsdi_status>Not initialized</div></td></tr>
</table>
</section>
<br>


</td></tr></table>

</article>

<script>


var pos = 0;

function get_appropriate_ws_url()
{
	var pcol;
	var u = document.URL;

	/* Y6SQTP
	 * We open the websocket encrypted if this page came on an
	 * https:// url itself, otherwise unencrypted
	 */

	if (u.substring(0, 5) == "https") {
		pcol = "wss://";
		u = u.substr(8);
	} else {
		pcol = "ws://";
		if (u.substring(0, 4) == "http")
			u = u.substr(7);
	}

	u = u.split('/');

	/* + "/xxx" bit is for IE10 workaround */

	//return pcol + u[0] + "/xxx";
	return "ws://192.168.1.109:9000/xxx"
}

function intToXdigitString(i, digit) {
	if ((i >= 0) && (digit > 0)) {
		var buf = "" + i;
		while (buf.length < digit) {
			buf = "0" + buf;
		}
		return buf;
	} else {
		var buf = "";
		while (buf.length < digit) {
			buf = "0" + buf;
		}
		return buf;
	}
//return i;
}



document.getElementById("lastmsg").textContent = get_appropriate_ws_url();

/* debugg protocol */
	
	var socket;

	if (typeof MozWebSocket != "undefined") {
		socket = new MozWebSocket(get_appropriate_ws_url(),
				   "ThingML-protocol");
	} else {
		socket = new WebSocket(get_appropriate_ws_url(),
				   "ThingML-protocol");
	}


	try {
		socket.onopen = function() {
			document.getElementById("wsdi_statustd").style.backgroundColor = "#40ff40";
			document.getElementById("wsdi_status").textContent = " websocket connection opened ";
		} 

		socket.onmessage =function got_packet(msg) {
			document.getElementById("lastmsg").textContent = msg.data + "\n";
			parseWSmsg(msg.data);
		} 

		socket.onclose = function(){
			document.getElementById("wsdi_statustd").style.backgroundColor = "#ff4040";
			document.getElementById("wsdi_status").textContent = " websocket connection CLOSED ";
		}
	} catch(exception) {
		alert('<p>Error' + exception);  
	}

function parseWSmsg(WSmsg) {
	if (((WSmsg.length % 3) != 1) || (WSmsg.length < 6)) {
		document.getElementById("info").textContent = "Error with msg:\"" + WSmsg + "\"\n";
	} else {
		//var tmp = parseInt(WSmsg.substring(0, 3));
		var msgcode = 256 * parseInt(WSmsg.substring(0, 3)) + parseInt(WSmsg.substring(3, 6));
		document.getElementById("info").textContent = "code:" + msgcode + " pI" + WSmsg.substring(0, 3) + " msg:" + WSmsg + "\n";
		switch(msgcode) {
			case 205:
				if (WSmsg.length < 15) {
					document.getElementById("info").textContent = "Error(size) with msg:\"" + WSmsg + "\"\n";
				} else {
					var pin = parseInt(WSmsg.substring(6, 9));
					var val = 256 * parseInt(WSmsg.substring(9, 12)) + parseInt(WSmsg.substring(12, 15));
					document.getElementById("info").textContent = "pin:" + pin + " val:" + val + "\n";
					document.getElementById("val" + pin).value = val;
				}
			break;
			default:
			document.getElementById("info").textContent = "code:" + msgcode  + " pI" + WSmsg.substring(0, 3) + " msg:" + WSmsg + "\n";
		}
	}
}

function CMD(target, instruction) {
	if (instruction == 1) {
		if (document.getElementById("status" + target).value === "Off") {
			document.getElementById("status" + target).value = "On";
			document.getElementById("status" + target).style.backgroundColor = "#40ff40";
			socket.send(intToXdigitString(200, 6) + intToXdigitString(target, 3));
			if (document.getElementById("IO" + target).value === "I") {
				socket.send(intToXdigitString(202, 6) + intToXdigitString(target, 3));
			} else {
				socket.send(intToXdigitString(203, 6) + intToXdigitString(target, 3));
			}
		} else {
			document.getElementById("status" + target).value = "Off";
			document.getElementById("status" + target).style.backgroundColor = "#ffffff";
			socket.send(intToXdigitString(201, 6) + intToXdigitString(target, 3));
		}
	} else if (instruction == 2) {
		if (document.getElementById("IO" + target).value === "I") {
			document.getElementById("IO" + target).value = "O";
			socket.send(intToXdigitString(203, 6) + intToXdigitString(target, 3));
		} else {
			document.getElementById("IO" + target).value = "I";
			socket.send(intToXdigitString(202, 6) + intToXdigitString(target, 3));
		}
	} else if (instruction == 3) {
		document.getElementById("val" + target).textContent = "On";
		socket.send(intToXdigitString(204, 6) + intToXdigitString(target, 3) + intToXdigitString(document.getElementById("val" + target).value, 6));
	}
}


</script>

</body>
</html>
